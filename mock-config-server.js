/**
 * Mock Config Server for local development
 *
 * Mimics the Spring Boot Config Server API for frontend testing.
 * Reads .properties files from config/i18n/{language}/{category}.properties
 *
 * Usage: node mock-config-server.js
 * Port: 8888
 *
 * @author Claude (Mock Server)
 * @version 1.0.0
 */

const http = require('http');
const fs = require('fs');
const path = require('path');

const PORT = 8888;
const CONFIG_DIR = path.join(__dirname, 'config');

/**
 * Parse .properties file to JSON object
 */
function parseProperties(content) {
  const result = {};
  const lines = content.split('\n');

  for (const line of lines) {
    const trimmed = line.trim();
    // Skip comments and empty lines
    if (!trimmed || trimmed.startsWith('#') || trimmed.startsWith('!')) {
      continue;
    }

    // Find first = or : separator
    const separatorIndex = trimmed.search(/[=:]/);
    if (separatorIndex === -1) continue;

    const key = trimmed.substring(0, separatorIndex).trim();
    let value = trimmed.substring(separatorIndex + 1).trim();

    // Handle escaped characters
    value = value
      .replace(/\\n/g, '\n')
      .replace(/\\t/g, '\t')
      .replace(/\\\\/g, '\\');

    result[key] = value;
  }

  return result;
}

/**
 * Load config from file
 */
function loadConfig(category, language, type = 'i18n') {
  let filePath;

  if (type === 'i18n') {
    filePath = path.join(CONFIG_DIR, 'i18n', language, `${category}.properties`);
  } else if (type === 'app') {
    filePath = path.join(CONFIG_DIR, 'app', `${category}.yml`);
  }

  console.log(`[CONFIG] Loading: ${filePath}`);

  if (!fs.existsSync(filePath)) {
    console.log(`[CONFIG] File not found: ${filePath}`);
    return null;
  }

  const content = fs.readFileSync(filePath, 'utf-8');
  return parseProperties(content);
}

/**
 * Get or create config with defaults
 */
function getOrCreateConfig(category, language, defaults = {}) {
  let config = loadConfig(category, language);

  if (!config) {
    // Create file with defaults
    const dir = path.join(CONFIG_DIR, 'i18n', language);
    const filePath = path.join(dir, `${category}.properties`);

    // Ensure directory exists
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
    }

    // Write defaults
    let content = `# Auto-generated by Mock Config Server\n# Category: ${category}\n# Language: ${language}\n\n`;
    for (const [key, value] of Object.entries(defaults)) {
      content += `${key}=${value}\n`;
    }

    fs.writeFileSync(filePath, content, 'utf-8');
    console.log(`[CONFIG] Created: ${filePath}`);

    config = defaults;
  } else {
    // Merge: existing values win over defaults
    config = { ...defaults, ...config };
  }

  return config;
}

/**
 * List available categories
 */
function listCategories(language) {
  const dir = path.join(CONFIG_DIR, 'i18n', language);
  if (!fs.existsSync(dir)) return [];

  return fs.readdirSync(dir)
    .filter(f => f.endsWith('.properties'))
    .map(f => f.replace('.properties', ''));
}

/**
 * List available languages
 */
function listLanguages() {
  const dir = path.join(CONFIG_DIR, 'i18n');
  if (!fs.existsSync(dir)) return [];

  return fs.readdirSync(dir)
    .filter(f => fs.statSync(path.join(dir, f)).isDirectory());
}

/**
 * Handle HTTP request
 */
function handleRequest(req, res) {
  // CORS headers
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.setHeader('Content-Type', 'application/json');

  // Handle preflight
  if (req.method === 'OPTIONS') {
    res.writeHead(204);
    res.end();
    return;
  }

  const url = new URL(req.url, `http://localhost:${PORT}`);
  const pathname = url.pathname;

  console.log(`[${req.method}] ${pathname}`);

  // Health check
  if (pathname === '/api/config/health') {
    res.writeHead(200);
    res.end(JSON.stringify({ status: 'UP', service: 'Mock Config Server', version: '1.0.0' }));
    return;
  }

  // Clear cache (no-op for mock)
  if (pathname === '/api/config/cache/clear') {
    res.writeHead(200);
    res.end(JSON.stringify({ status: 'success', message: 'Cache cleared (mock)' }));
    return;
  }

  // List languages
  if (pathname === '/api/config/i18n/languages') {
    const languages = listLanguages();
    res.writeHead(200);
    res.end(JSON.stringify(languages));
    return;
  }

  // List categories
  const categoriesMatch = pathname.match(/^\/api\/config\/i18n\/categories\/(\w+)$/);
  if (categoriesMatch) {
    const language = categoriesMatch[1];
    const categories = listCategories(language);
    res.writeHead(200);
    res.end(JSON.stringify(categories));
    return;
  }

  // I18N config: POST /api/config/i18n/{category}/{language}
  const i18nMatch = pathname.match(/^\/api\/config\/i18n\/([^/]+)\/(\w+)$/);
  if (i18nMatch) {
    const category = i18nMatch[1];
    const language = i18nMatch[2];

    if (req.method === 'POST') {
      // Read body for defaults
      let body = '';
      req.on('data', chunk => body += chunk);
      req.on('end', () => {
        let defaults = {};
        try {
          if (body) defaults = JSON.parse(body);
        } catch (e) {
          console.log('[CONFIG] Invalid JSON body, using empty defaults');
        }

        const config = getOrCreateConfig(category, language, defaults);
        res.writeHead(200);
        res.end(JSON.stringify(config));
      });
      return;
    }

    if (req.method === 'GET') {
      const config = loadConfig(category, language) || {};
      res.writeHead(200);
      res.end(JSON.stringify(config));
      return;
    }
  }

  // App config: POST/GET /api/config/app/{category}
  const appMatch = pathname.match(/^\/api\/config\/app\/([^/]+)$/);
  if (appMatch) {
    const category = appMatch[1];

    // For app config, just return empty or read from yml
    const config = {};
    res.writeHead(200);
    res.end(JSON.stringify(config));
    return;
  }

  // 404 for unknown routes
  res.writeHead(404);
  res.end(JSON.stringify({ error: 'Not Found', path: pathname }));
}

// Create server
const server = http.createServer(handleRequest);

server.listen(PORT, () => {
  console.log('');
  console.log('========================================');
  console.log('  Mock Config Server v1.0.0');
  console.log('========================================');
  console.log(`  Port: ${PORT}`);
  console.log(`  Config Dir: ${CONFIG_DIR}`);
  console.log('');
  console.log('  Endpoints:');
  console.log('  - POST /api/config/i18n/{category}/{language}');
  console.log('  - GET  /api/config/i18n/{category}/{language}');
  console.log('  - GET  /api/config/i18n/categories/{language}');
  console.log('  - GET  /api/config/i18n/languages');
  console.log('  - GET  /api/config/health');
  console.log('========================================');
  console.log('');
});
